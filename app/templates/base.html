<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}RecallAI{% endblock %} | Sistema de Aprendizaje Adaptativo</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    {% block extra_css %}{% endblock %}
    
    <style>
        .brand-link {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .brand-image {
            opacity: .8;
        }
        .content-wrapper {
            background-color: #f4f6f9;
        }
    </style>
    
    <!-- CSRF Token para AJAX -->
    <script>
        window.CSRF_TOKEN = '{{ csrf_token }}';
    </script>
</head>
<body class="hold-transition {% block body_class %}{% endblock %}">
    <div class="wrapper">
        {% block content %}{% endblock %}
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <!-- Configurar CSRF para todas las peticiones AJAX -->
    <script>
        // Configurar jQuery para incluir CSRF token en todas las peticiones AJAX
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", window.CSRF_TOKEN);
                }
            }
        });
    </script>
    
    <!-- Configurar CSRF para todas las peticiones AJAX -->
    <script>
        // Configurar jQuery para incluir CSRF token en todas las peticiones AJAX
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", window.CSRF_TOKEN);
                }
            }
        });
        
        // âœ… SISTEMA MEJORADO DE NOTIFICACIONES
        let notificationPollingInterval = null;
        
        function updateNotificationBadge() {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            const badge = $('.navbar-badge');
            if (badge.length > 0) {
                if (unreadCount > 0) {
                    badge.text(unreadCount).show();
                } else {
                    badge.hide();
                }
            }
        }
        
        function loadNotifications() {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            if (notifications.length === 0) {
                return '<span class="dropdown-item dropdown-header">Sin notificaciones</span>';
            }
            
            let html = '<span class="dropdown-item dropdown-header">' + notifications.length + ' Notificaciones</span>';
            html += '<div class="dropdown-divider"></div>';
            
            notifications.slice(0, 5).forEach(function(notif) {
                const timeAgo = getTimeAgo(notif.timestamp);
                const readClass = notif.read ? 'text-muted' : '';
                html += `
                    <a href="/materials/history/${notif.text_id}/" class="dropdown-item notification-item ${readClass}" data-id="${notif.id}">
                        <i class="fas fa-lightbulb mr-2"></i> ${notif.material_name} generado
                        <br><small class="text-muted">${notif.text_title}</small>
                        <br><small class="text-muted">${timeAgo}</small>
                    </a>
                    <div class="dropdown-divider"></div>
                `;
            });
            
            if (notifications.length > 5) {
                html += '<a href="#" class="dropdown-item dropdown-footer">Ver todas las notificaciones</a>';
            }
            
            return html;
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Hace un momento';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `Hace ${diffDays} dÃ­a${diffDays > 1 ? 's' : ''}`;
        }
        
        // âœ… POLLING GLOBAL: Verifica si hay material pendiente
        function checkPendingMaterials() {
            const pendingMaterialStr = localStorage.getItem('pending_material');
            
            if (!pendingMaterialStr) {
                return; // No hay material pendiente
            }
            
            const pendingMaterial = JSON.parse(pendingMaterialStr);
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                return;
            }
            
            // Verificar si ya pasaron mÃ¡s de 10 minutos (timeout)
            const startedAt = new Date(pendingMaterial.started_at);
            const now = new Date();
            const elapsedMinutes = (now - startedAt) / 60000;
            
            if (elapsedMinutes > 10) {
                // Timeout - remover del tracking
                localStorage.removeItem('pending_material');
                console.log('Material generation timeout - removed from tracking');
                return;
            }
            
            // Verificar si el material ya fue generado
            $.ajax({
                url: '/api/texts/my-materials/',
                type: 'GET',
                cache: false,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(materials) {
                    const newMaterial = materials.find(m =>
                        m.material_type === pendingMaterial.material_type &&
                        m.text === parseInt(pendingMaterial.text_id) &&
                        m.generated_at !== null &&
                        new Date(m.generated_at) > startedAt
                    );
                    
                    if (newMaterial) {
                        console.log('âœ… Material generado:', newMaterial);
                        
                        // âœ… Agregar notificaciÃ³n
                        addNotification(newMaterial, pendingMaterial);
                        
                        // âœ… Remover del tracking
                        localStorage.removeItem('pending_material');
                        
                        // âœ… Mostrar toast de Ã©xito
                        toastr.success('Â¡Material didÃ¡ctico generado exitosamente! Haz clic en la campana para verlo ðŸ””', '', {
                            timeOut: 5000
                        });
                        
                        // âœ… Actualizar badge
                        updateNotificationBadge();
                    }
                },
                error: function(xhr) {
                    console.error('Error checking materials:', xhr);
                }
            });
        }
        
        function addNotification(material, pendingMaterial) {
            let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            const materialNames = {
                'flashcard': 'Flashcards',
                'decision_tree': 'Ãrbol de DecisiÃ³n',
                'mind_map': 'Mapa Mental',
                'summary': 'Resumen Estructurado'
            };
            
            // Verificar que no exista ya
            const exists = notifications.some(n => n.id === material.id);
            if (exists) {
                return;
            }
            
            notifications.unshift({
                id: material.id,
                text_id: pendingMaterial.text_id,
                text_title: pendingMaterial.text_title,
                material_type: material.material_type,
                material_name: materialNames[material.material_type],
                timestamp: new Date().toISOString(),
                read: false
            });
            
            // Mantener solo Ãºltimas 20 notificaciones
            notifications = notifications.slice(0, 20);
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }
        
        // âœ… Iniciar polling cuando la pÃ¡gina carga
        $(document).ready(function() {
            updateNotificationBadge();
            
            // Verificar inmediatamente
            checkPendingMaterials();
            
            // âœ… Polling cada 10 segundos para verificar material pendiente
            notificationPollingInterval = setInterval(function() {
                checkPendingMaterials();
            }, 10000); // 10 segundos
            
            // Actualizar badge cada 30 segundos
            setInterval(updateNotificationBadge, 30000);
        });
        
        // Limpiar intervalo al salir de la pÃ¡gina
        $(window).on('beforeunload', function() {
            if (notificationPollingInterval) {
                clearInterval(notificationPollingInterval);
            }
        });
        
        // Marcar notificaciÃ³n como leÃ­da al hacer click
        $(document).on('click', '.notification-item', function() {
            const notifId = $(this).data('id');
            let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            notifications = notifications.map(n => {
                if (n.id === notifId) {
                    n.read = true;
                }
                return n;
            });
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>