{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block body_class %}sidebar-mini layout-fixed{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="/dashboard/" class="nav-link">Inicio</a>
        </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
        <!-- Notifications Dropdown Menu -->
        <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
                <i class="far fa-bell"></i>
                <span class="badge badge-warning navbar-badge">0</span>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                <span class="dropdown-item dropdown-header">0 Notificaciones</span>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">
                    <i class="fas fa-info mr-2"></i> Sin notificaciones
                </a>
            </div>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                <i class="fas fa-expand-arrows-alt"></i>
            </a>
        </li>
    </ul>
</nav>

<!-- Main Sidebar Container -->
<aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="/dashboard/" class="brand-link">
        <i class="fas fa-brain brand-image ml-3"></i>
        <span class="brand-text font-weight-light">RecallAI</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Sidebar user panel -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
                <i class="fas fa-user-circle fa-2x text-white"></i>
            </div>
            <div class="info">
                <a href="#" class="d-block" id="userName">Usuario</a>
            </div>
        </div>

        <!-- Sidebar Menu -->
        <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                <li class="nav-item">
                    <a href="/dashboard/" class="nav-link active">
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        <p>Dashboard</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-book"></i>
                        <p>Mis Textos</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-clipboard-check"></i>
                        <p>Cuestionarios</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-lightbulb"></i>
                        <p>Material Did√°ctico</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-chart-line"></i>
                        <p>Mi Progreso</p>
                    </a>
                </li>
                <li class="nav-header">CONFIGURACI√ìN</li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-user-cog"></i>
                        <p>Mi Perfil</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">
                        <i class="nav-icon fas fa-sign-out-alt"></i>
                        <p>Cerrar Sesi√≥n</p>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</aside>

<!-- Content Wrapper -->
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Dashboard</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                        <li class="breadcrumb-item active">Dashboard</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Info boxes -->
            <div class="row">
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box">
                        <span class="info-box-icon bg-info elevation-1"><i class="fas fa-book"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Textos Estudiados</span>
                            <span class="info-box-number">0</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box mb-3">
                        <span class="info-box-icon bg-success elevation-1"><i class="fas fa-clipboard-check"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Cuestionarios</span>
                            <span class="info-box-number">0</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box mb-3">
                        <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-lightbulb"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Material Generado</span>
                            <span class="info-box-number">0</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box mb-3">
                        <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-fire"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Racha de Estudio</span>
                            <span class="info-box-number">0 d√≠as</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bienvenida -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-book-reader mr-2"></i>
                                Textos Disponibles
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="textsLoading" class="text-center">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Cargando textos...</p>
                            </div>
                            
                            <div id="textsContainer" class="row" style="display: none;">
                                <!-- Se llenar√° din√°micamente con JavaScript -->
                            </div>
                            
                            <div id="noTexts" class="alert alert-info" style="display: none;">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>No hay textos disponibles a√∫n.</strong>
                                Los administradores est√°n preparando el contenido.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Footer -->
<footer class="main-footer">
    <strong>Copyright &copy; 2024 <a href="#">RecallAI</a>.</strong>
    Todos los derechos reservados.
    <div class="float-right d-none d-sm-inline-block">
        <b>Versi√≥n</b> 1.0.0
    </div>
</footer>
{% endblock %}

{% block extra_js %}
<script>
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "3000"
    };

    // Verificar autenticaci√≥n
    $(document).ready(function() {
        const token = localStorage.getItem('access_token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) {
            window.location.href = '/login/';
            return;
        }
        
        // Mostrar nombre del usuario
        if (user.first_name) {
            $('#userName').text(user.first_name + ' ' + user.last_name);
            $('#userNameWelcome').text(user.first_name);
        }
        
        // Cargar textos disponibles
        loadTexts();
        
        // Cargar estad√≠sticas
        loadStats();
    });

    // Funci√≥n para cargar textos
    function loadTexts() {
        const token = localStorage.getItem('access_token');
        
        $.ajax({
            url: '/api/texts/',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                $('#textsLoading').hide();
                
                if (response.length === 0) {
                    $('#noTexts').show();
                } else {
                    renderTexts(response);
                    $('#textsContainer').show();
                }
            },
            error: function(xhr) {
                $('#textsLoading').hide();
                toastr.error('Error al cargar textos');
                
                // Si token expir√≥, redirigir a login
                if (xhr.status === 401) {
                    localStorage.clear();
                    window.location.href = '/login/';
                }
            }
        });
    }

    // Funci√≥n para renderizar textos
    function renderTexts(texts) {
            let html = '';
            
            texts.forEach(function(text) {
                const difficultyBadge = getDifficultyBadge(text.difficulty);
                
                let attemptedBadge = '';
                let buttonText = '<i class="fas fa-book-open"></i> Estudiar';
                let buttonClass = 'btn-primary';
                
                if (text.has_been_attempted) {
                    attemptedBadge = '<span class="badge badge-success">‚úÖ Completado</span>';
                    buttonText = '<i class="fas fa-eye"></i> Ver Resultado';
                    buttonClass = 'btn-info';
                } else {
                    attemptedBadge = '<span class="badge badge-warning">üìù Pendiente</span>';
                }
                
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card ${text.has_been_attempted ? 'border-success' : ''}">
                            <div class="card-body">
                                <h5 class="card-title">${text.title}</h5>
                                <p class="card-text text-muted">${text.description || 'Sin descripci√≥n'}</p>
                                
                                <div class="mb-2">
                                    <span class="badge badge-primary">${text.topic}</span>
                                    ${difficultyBadge}
                                    ${attemptedBadge}
                                </div>
                                
                                <div class="text-muted small mb-3">
                                    <i class="far fa-clock"></i> ${text.estimated_time_minutes} min
                                    <i class="fas fa-font ml-2"></i> ${text.word_count} palabras
                                </div>
                                
                                ${text.has_been_attempted 
                                    ? `<a href="/quiz/${text.id}/results/" class="btn ${buttonClass} btn-block">${buttonText}</a>`
                                    : `<a href="/text/${text.id}/" class="btn ${buttonClass} btn-block">${buttonText}</a>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#textsContainer').html(html);
        }

    // Helper para badge de dificultad
    function getDifficultyBadge(difficulty) {
        const badges = {
            'beginner': '<span class="badge badge-success">Principiante</span>',
            'intermediate': '<span class="badge badge-warning">Intermedio</span>',
            'advanced': '<span class="badge badge-danger">Avanzado</span>'
        };
        return badges[difficulty] || '';
    }

    // Funci√≥n para cargar estad√≠sticas
    function loadStats() {
        const token = localStorage.getItem('access_token');
        
        $.ajax({
            url: '/api/attempts/stats/',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(stats) {
                // Actualizar info boxes
                $('.info-box-number').eq(0).text(stats.texts_studied);
                $('.info-box-number').eq(1).text(stats.total_attempts);
                $('.info-box-number').eq(3).text(stats.study_streak + ' d√≠as');
            },
            error: function(xhr) {
                console.log('Error al cargar estad√≠sticas');
            }
        });
    }

    // Logout
    $('#logoutBtn').on('click', function(e) {
        e.preventDefault();
        
        const refresh_token = localStorage.getItem('refresh_token');
        
        $.ajax({
            url: '/api/auth/logout/',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            contentType: 'application/json',
            data: JSON.stringify({
                refresh_token: refresh_token
            }),
            complete: function() {
                // Limpiar localStorage
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                
                toastr.success('Sesi√≥n cerrada correctamente');
                
                setTimeout(function() {
                    window.location.href = '/login/';
                }, 1000);
            }
        });
    });
</script>
{% endblock %}