{% extends 'base.html' %}

{% block title %}Cuestionario{% endblock %}

{% block body_class %}sidebar-mini layout-fixed{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
        <li class="nav-item d-none d-sm-inline-block">
            <span class="nav-link">
                <i class="fas fa-clipboard-check"></i>
                <strong>Cuestionario en progreso...</strong>
            </span>
        </li>
    </ul>

    <ul class="navbar-nav ml-auto">
        <li class="nav-item">
            <span class="nav-link">
                <i class="far fa-clock"></i>
                <span id="quizTimer">00:00</span>
            </span>
        </li>
    </ul>
</nav>

<!-- Content Wrapper (sin sidebar para evitar distracciones) -->
<div class="content-wrapper" style="margin-left: 0;">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-12 text-center">
                    <h1 class="m-0" id="quizTitle">Cargando cuestionario...</h1>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container">
            <!-- Loading -->
            <div id="loadingQuiz" class="text-center">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p class="mt-3">Preparando cuestionario...</p>
            </div>

            <!-- Cuestionario -->
            <div id="quizContent" style="display: none;">
                <div class="row justify-content-center">
                    <div class="col-md-10">
                        <!-- Progreso -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Pregunta <strong id="currentQuestion">1</strong> de <strong id="totalQuestions">20</strong></span>
                                    <span class="text-muted">Intento #<span id="attemptNumber">1</span></span>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 5%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Pregunta actual -->
                        <div class="card" id="questionCard">
                            <div class="card-header bg-primary">
                                <h4 class="card-title mb-0">
                                    <i class="fas fa-question-circle"></i>
                                    <span id="questionText"></span>
                                </h4>
                            </div>
                            <div class="card-body">
                                <div id="optionsContainer"></div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <button id="prevBtn" class="btn btn-secondary" disabled>
                                        <i class="fas fa-arrow-left"></i> Anterior
                                    </button>
                                    <button id="nextBtn" class="btn btn-primary">
                                        Siguiente <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button id="submitBtn" class="btn btn-success" style="display: none;">
                                        <i class="fas fa-check"></i> Finalizar Cuestionario
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de Confirmación -->
                        <div class="modal fade" id="confirmSubmitModal" tabindex="-1" role="dialog" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header bg-warning">
                                        <h5 class="modal-title">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            ¿Estás seguro?
                                        </h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body text-center">
                                        <i class="fas fa-clipboard-check fa-4x text-warning mb-3"></i>
                                        <h4>¿Finalizar cuestionario?</h4>
                                        <p class="lead">Has respondido <strong id="answeredCount">0</strong> de <strong id="totalQuestionsModal">20</strong> preguntas.</p>
                                        <div id="unansweredWarning" class="alert alert-danger" style="display: none;">
                                            <i class="fas fa-exclamation-circle"></i>
                                            ¡Aún faltan preguntas por responder!
                                        </div>
                                        <p class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Solo puedes tomar este cuestionario <strong>UNA vez</strong>
                                        </p>
                                    </div>
                                    <div class="modal-footer justify-content-center">
                                        <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal">
                                            <i class="fas fa-times"></i> Cancelar
                                        </button>
                                        <button type="button" class="btn btn-success btn-lg" id="confirmSubmitBtn">
                                            <i class="fas fa-check"></i> Sí, Finalizar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navegación rápida -->
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="fas fa-th"></i> Navegación Rápida</h6>
                                <div id="quickNav" class="d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let textId;
    let quizData;
    let userAnswers = {};
    let currentQuestionIndex = 0;
    let startTime;
    let timerInterval;
    let isSubmitting = false; // Flag para prevenir doble submit

    $(document).ready(function() {
        // Obtener ID del texto
        const pathParts = window.location.pathname.split('/');
        textId = pathParts[2];
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return;
        }
        
        // Cargar cuestionario
        loadQuiz();
        
        // Iniciar cronómetro
        startQuizTimer();
    });

    function loadQuiz() {
        const token = localStorage.getItem('access_token');
        
        $.ajax({
            url: `/api/texts/${textId}/quiz/`,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                quizData = response.quiz;
                
                $('#quizTitle').text('Cuestionario: ' + quizData.text_title);
                $('#attemptNumber').text(response.next_attempt_number);
                $('#totalQuestions').text(quizData.total_questions);
                $('#totalQuestionsModal').text(quizData.total_questions);
                
                // Renderizar navegación rápida
                renderQuickNav();
                
                // Mostrar primera pregunta
                showQuestion(0);
                
                $('#loadingQuiz').hide();
                $('#quizContent').show();
            },
            error: function(xhr) {
                if (xhr.status === 403 && xhr.responseJSON && xhr.responseJSON.already_taken) {
                    // Ya tomó el cuestionario
                    $('#loadingQuiz').html(
                        '<div class="alert alert-warning text-center">' +
                        '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i>' +
                        '<h4>Ya completaste este cuestionario</h4>' +
                        '<p>Solo puedes tomar el cuestionario inicial una vez por texto.</p>' +
                        '<a href="/dashboard/" class="btn btn-primary mt-3">' +
                        '<i class="fas fa-home"></i> Volver al Dashboard' +
                        '</a>' +
                        '</div>'
                    );
                } else {
                    $('#loadingQuiz').html(
                        '<div class="alert alert-danger text-center">' +
                        '<i class="fas fa-exclamation-circle fa-3x mb-3"></i>' +
                        '<h4>Error al cargar cuestionario</h4>' +
                        '<p>' + (xhr.responseJSON?.error || 'Error desconocido') + '</p>' +
                        '<a href="/dashboard/" class="btn btn-primary mt-3">' +
                        '<i class="fas fa-home"></i> Volver al Dashboard' +
                        '</a>' +
                        '</div>'
                    );
                }
            }
        });
    }

    function renderQuickNav() {
        let navHtml = '';
        for (let i = 0; i < quizData.total_questions; i++) {
            navHtml += `<button class="btn btn-sm btn-outline-secondary quick-nav-btn m-1" data-index="${i}">${i + 1}</button>`;
        }
        $('#quickNav').html(navHtml);
        
        // Event listeners para navegación rápida
        $('.quick-nav-btn').on('click', function() {
            const index = parseInt($(this).data('index'));
            showQuestion(index);
        });
    }

    function showQuestion(index) {
        if (index < 0 || index >= quizData.total_questions) return;
        
        currentQuestionIndex = index;
        const question = quizData.questions_json[index];
        
        // Actualizar UI
        $('#currentQuestion').text(index + 1);
        $('#questionText').text(question.pregunta);
        
        // Renderizar opciones
        let optionsHtml = '';
        question.opciones.forEach(function(opcion, idx) {
            const letter = opcion.charAt(0);
            const isChecked = userAnswers[index] === letter ? 'checked' : '';
            
            optionsHtml += `
                <div class="form-check mb-3" style="font-size: 16px;">
                    <input class="form-check-input" type="radio" name="answer" id="option${idx}" value="${letter}" ${isChecked}>
                    <label class="form-check-label" for="option${idx}" style="cursor: pointer;">
                        ${opcion}
                    </label>
                </div>
            `;
        });
        $('#optionsContainer').html(optionsHtml);
        
        // Event listener para guardar respuesta
        $('input[name="answer"]').on('change', function() {
            userAnswers[currentQuestionIndex] = $(this).val();
            updateQuickNav();
        });
        
        // Botones de navegación
        $('#prevBtn').prop('disabled', index === 0);
        
        if (index === quizData.total_questions - 1) {
            $('#nextBtn').hide();
            $('#submitBtn').show();
        } else {
            $('#nextBtn').show();
            $('#submitBtn').hide();
        }
        
        // Actualizar progreso
        const progress = ((index + 1) / quizData.total_questions) * 100;
        $('#progressBar').css('width', progress + '%');
        
        // Actualizar navegación rápida
        updateQuickNav();
    }

    function updateQuickNav() {
        $('.quick-nav-btn').each(function() {
            const index = parseInt($(this).data('index'));
            
            if (userAnswers[index]) {
                $(this).removeClass('btn-outline-secondary').addClass('btn-success');
            } else {
                $(this).removeClass('btn-success').addClass('btn-outline-secondary');
            }
            
            if (index === currentQuestionIndex) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
    }

    function startQuizTimer() {
        startTime = Date.now();
        
        timerInterval = setInterval(function() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            $('#quizTimer').text(
                String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0')
            );
        }, 1000);
    }

    // Navegación
    $('#nextBtn').on('click', function() {
        showQuestion(currentQuestionIndex + 1);
    });

    $('#prevBtn').on('click', function() {
        showQuestion(currentQuestionIndex - 1);
    });

    // Botón de enviar - Muestra modal en lugar de confirm()
    $('#submitBtn').on('click', function() {
        const answeredCount = Object.keys(userAnswers).length;
        
        // Actualizar contador en modal
        $('#answeredCount').text(answeredCount);
        
        // Mostrar/ocultar advertencia
        if (answeredCount < quizData.total_questions) {
            $('#unansweredWarning').show();
        } else {
            $('#unansweredWarning').hide();
        }
        
        // Mostrar modal
        $('#confirmSubmitModal').modal('show');
    });

    // Confirmar envío desde el modal
    $('#confirmSubmitBtn').on('click', function() {
        // Verificar que todas las preguntas estén respondidas
        if (Object.keys(userAnswers).length < quizData.total_questions) {
            toastr.warning('Por favor responde todas las preguntas antes de finalizar');
            return;
        }
        
        // Cerrar modal
        $('#confirmSubmitModal').modal('hide');
        
        // Enviar cuestionario
        submitQuiz();
    });

    function submitQuiz() {
        if (isSubmitting) return; // Prevenir doble submit
        isSubmitting = true;
        
        clearInterval(timerInterval);
        
        const token = localStorage.getItem('access_token');
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);
        
        // Preparar respuestas
        const answers = [];
        for (let i = 0; i < quizData.total_questions; i++) {
            answers.push({
                question_index: i,
                selected_answer: userAnswers[i] || ''
            });
        }
        
        // Deshabilitar botón
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Evaluando...');
        
        // ✅ IMPORTANTE: Remover warning ANTES de enviar
        window.onbeforeunload = null;
        
        $.ajax({
            url: `/api/texts/${textId}/submit-quiz/`,
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                answers: answers,
                time_spent_seconds: timeSpent
            }),
            success: function(response) {
                // Guardar resultado en localStorage
                localStorage.setItem('quiz_result', JSON.stringify(response));
                
                // Redirigir a página de resultados
                window.location.href = `/quiz/${textId}/results/`;
            },
            error: function(xhr) {
                isSubmitting = false;
                $('#submitBtn').prop('disabled', false).html('<i class="fas fa-check"></i> Finalizar Cuestionario');
                toastr.error('Error al enviar cuestionario');
                
                // Restaurar warning
                window.onbeforeunload = function() {
                    return "¿Estás seguro de que quieres salir? Perderás tu progreso.";
                };
            }
        });
    }

    // Prevenir salir accidentalmente (se remueve al enviar correctamente)
    window.onbeforeunload = function() {
        if (!isSubmitting) {
            return "¿Estás seguro de que quieres salir? Perderás tu progreso.";
        }
    };
</script>
{% endblock %}