{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Material... - RecallAI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
        :root {
            --color-flashcard-bg: #e3f2fd;
            --color-flashcard-fg: #1976d2;
            --color-decision_tree-bg: #f3e5f5;
            --color-decision_tree-fg: #7b1fa2;
            --color-mind_map-bg: #e8f5e9;
            --color-mind_map-fg: #388e3c;
            --color-summary-bg: #fff3e0;
            --color-summary-fg: #f57c00;
            --color-default-bg: #f0f0f0;
            --color-default-fg: #555;
        }

        body { 
            background: #f4f6f9; 
            min-height: 100vh; 
            padding: 20px 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .material-container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        .material-header { 
            background: white; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden; 
        }
        
        .header-title-area {
            padding: 25px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            background: var(--color-default-bg); 
            color: var(--color-default-fg); 
            transition: all 0.5s ease;
            position: relative;
        }
        
        .header-title-area.type-flashcard {
            background: linear-gradient(135deg, var(--color-flashcard-bg) 0%, #ffffff 100%);
            color: var(--color-flashcard-fg);
            border-bottom: 3px solid var(--color-flashcard-fg);
        }
        .header-title-area.type-decision_tree {
            background: linear-gradient(135deg, var(--color-decision_tree-bg) 0%, #ffffff 100%);
            color: var(--color-decision_tree-fg);
            border-bottom: 3px solid var(--color-decision_tree-fg);
        }
        .header-title-area.type-mind_map {
            background: linear-gradient(135deg, var(--color-mind_map-bg) 0%, #ffffff 100%);
            color: var(--color-mind_map-fg);
            border-bottom: 3px solid var(--color-mind_map-fg);
        }
        .header-title-area.type-summary {
            background: linear-gradient(135deg, var(--color-summary-bg) 0%, #ffffff 100%);
            color: var(--color-summary-fg);
            border-bottom: 3px solid var(--color-summary-fg);
        }

        .header-title { 
            flex: 1; 
            min-width: 0; 
            text-align: center;
        }
        .header-title h1 {
            margin: 0;
            font-size: 1.7rem; 
            font-weight: 700;
            line-height: 1.3;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .header-title p {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        .header-title-area > div:last-child {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn-custom { 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.3s;
            flex-shrink: 0;
            background: #fff;
            color: #007bff;
            border: 1px solid #007bff;
        }
        .btn-custom:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
            background: #007bff;
            color: #fff;
        }

        /* --- ESTILOS PARA TÓPICOS --- */
        .topics-section {
            padding: 20px 30px;
            background: #fff;
        }
        .topics-section.weak {
            border-bottom: 1px solid #eee;
        }
        
        .topics-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .topics-title.weak { color: #721c24; }
        .topics-title.strong { color: #155724; }

        .topics-list { 
            display: flex; 
            flex-wrap: wrap;
            gap: 10px; 
        }
        
        .topic-tag-red { 
            background: #fff5f5; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .topic-tag-red .icon {
            margin-right: 8px;
            color: #c53030;
            font-size: 12px;
        }
        
        .topic-tag-green { 
            background: #f0fff4; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .topic-tag-green .icon {
            margin-right: 8px;
            color: #28a745; 
            font-size: 12px;
        }

        .material-content { 
            background: white; 
            border-radius: 16px; 
            padding: 30px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
            min-height: 500px; 
        }
        
        #materialContent { animation: fadeIn 0.5s; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .loading-spinner { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 400px; 
            flex-direction: column; 
        }
        .spinner-border-custom { 
            width: 3rem; 
            height: 3rem; 
            border-width: 0.3em; 
        }

        /* --- ESTILOS PARA EL MAPA D3 --- */
        #arbol-container {
            background-color: #ffffff !important; 
        }
        
        .arbol-link {
            stroke: #ccc;
            stroke-width: 2px;
            fill: none;
        }
        
        g.arbol-nodo {
            cursor: pointer;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.08));
            transition: filter 0.3s ease;
        }
        g.arbol-nodo:hover {
            filter: drop-shadow(0 6px 16px rgba(0,0,0,0.12));
        }
        
        g.arbol-nodo rect {
            transition: stroke 0.3s ease, fill 0.3s ease, height 0.3s ease, y 0.3s ease; 
        }
        
        .arbol-texto-contenedor {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 8px;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #333333;
            word-wrap: break-word; 
            line-height: 1.2;
            overflow: hidden;
        }

        .arbol-texto-contenedor.tema-debil {
            color: #E74C3C;
            font-weight: bold;
        }
        
        .arbol-texto-contenedor.raiz {
            font-size: 15px;
            font-weight: bold;
        }

        .arbol-boton-toggle circle {
            transition: all 0.3s ease;
        }
        .arbol-boton-toggle:hover circle {
            transform: scale(1.1);
        }
        .arbol-boton-toggle text {
            pointer-events: none;
        }

    </style>
</head>
<body>
    <div class="material-container">
        
        <div class="material-header">
            <div class="header-title-area" id="headerTitleArea">
                <div class="header-title">
                    <p id="materialType">Cargando...</p>
                    <h1 id="materialTitle">Material de Estudio</h1>
                </div>
                <div>
                    <a href="/dashboard/" class="btn btn-custom">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </div>
            </div>
        
            <div class="topics-section strong" id="strongTopicsContainer" style="display: none;">
                <h3 class="topics-title strong">Temas dominados (Temas generales)</h3>
                <div class="topics-list" id="strongTopicsList"></div>
            </div>
            
            <div class="topics-section weak" id="weakTopicsContainer" style="display: none;">
                <h3 class="topics-title weak">Temas débiles</h3>
                <div class="topics-list" id="weakTopicsList"></div>
            </div>
        </div>

        <div class="material-content">
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary spinner-border-custom" role="status">
                    <span class="sr-only">Cargando...</span>
                </div>
                <p class="mt-3 text-muted" id="loadingText">Generando tu material personalizado, esto puede tardar unos minutos...</p>
            </div>
            <div id="materialContent" style="display: none;"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        let materialData = null;
        const materialId = window.location.pathname.split('/')[2]; 

        $(document).ready(function() {
            loadMaterial();
        });

        function loadMaterial() {
            const token = localStorage.getItem('access_token');

            if (!token) {
                window.location.href = '/login/';
                return;
            }

            const apiUrl = `/api/materials/${materialId}/`;

            $.ajax({
                url: apiUrl,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(material) {
                    materialData = material;
                    displayMaterial(materialData);
                    loadAndDisplayStrongTopics(material.text, material.weak_topics);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        localStorage.clear();
                        window.location.href = '/login/';
                    } else if (xhr.status === 404) {
                        toastr.error('Material no encontrado.');
                        $('#loadingSpinner').show(); 
                        $('#loadingText').text('Este material no existe o no te pertenece.');
                        $('#materialType').text('Error');
                        $('#materialTitle').text('Material no encontrado');
                    } else {
                        toastr.error('Error al cargar el material.');
                        $('#loadingSpinner').show();
                        $('#loadingText').text('Ocurrió un error inesperado al cargar el material.');
                    }
                }
            });
        }
        
        function displayMaterial(material) {
            materialData = material;

            $('#headerTitleArea').addClass('type-' + material.material_type);
            $('#materialType').text(material.material_type_display);
            $('#materialTitle').text(material.text_title);
            document.title = `${material.material_type_display}: ${material.text_title} - RecallAI`;
            
            if (material.weak_topics && material.weak_topics.length > 0) {
                const topicsHTML = material.weak_topics.map(topic => 
                    `<span class="topic-tag-red"><i class="fas fa-exclamation-triangle icon"></i> ${topic}</span>`
                ).join('');
                $('#weakTopicsList').html(topicsHTML);
                $('#weakTopicsContainer').show();
            }

            // === LÓGICA MAPA CONCEPTUAL ===
            if (material.material_type === 'decision_tree') {
                let arbolData = null;
                try {
                    arbolData = JSON.parse(material.html_content);
                } catch (e1) {
                    try {
                        let cleanContent = material.html_content.trim();
                        if (cleanContent.startsWith('```')) {
                            cleanContent = cleanContent.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                        }
                        const jsonStart = cleanContent.indexOf('{');
                        const jsonEnd = cleanContent.lastIndexOf('}');
                        if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                            cleanContent = cleanContent.substring(jsonStart, jsonEnd + 1);
                        }
                        arbolData = JSON.parse(cleanContent);
                    } catch (e2) {
                        $('#loadingSpinner').hide();
                        $('#materialContent').html('<div class="alert alert-danger">Error formato JSON</div>').fadeIn();
                        return;
                    }
                }
                
                if (!arbolData || !arbolData.datos || !arbolData.datos.nodos) {
                    $('#loadingSpinner').hide();
                    $('#materialContent').html('<div class="alert alert-warning">Datos incompletos</div>').fadeIn();
                    return;
                }
                
                $('#loadingSpinner').hide();
                renderizarArbolDecision(arbolData);
                trackMaterialView(material.id);
                return;
            }
            // === FIN LÓGICA MAPA ===

            // Lógica para Flashcards/Otros
            let cleanHTML;
            if (material.material_type === 'flashcard') {
                cleanHTML = material.html_content;
            } else {
                cleanHTML = DOMPurify.sanitize(material.html_content, {
                    ADD_TAGS: ['style', 'script'],
                    ADD_ATTR: ['onclick', 'onmouseover', 'onmouseout', 'style', 'id', 'class']
                });
            }

            $('#loadingSpinner').hide();
            const contentDiv = $('#materialContent');
            contentDiv.html(cleanHTML).fadeIn();
            
            if (material.material_type === 'flashcard') {
                const scripts = contentDiv.find('script');
                scripts.each(function() {
                    const scriptContent = $(this).html();
                    if (scriptContent) {
                        try { window.eval(scriptContent); } catch (e) { console.error(e); }
                    }
                });
            }
            
            trackMaterialView(material.id);
        }

        function loadAndDisplayStrongTopics(textId, weakTopics) {
            const strongTopicsSection = $('#strongTopicsContainer');
            fetch(`/api/texts/${textId}/quiz/`)
                .then(response => response.ok ? response.json() : Promise.reject('Error'))
                .then(data => {
                    if (!data.quiz || !data.quiz.questions_json) {
                        strongTopicsSection.hide();
                        return; 
                    }
                    const questions = data.quiz.questions_json;
                    const allTopics = new Set();
                    questions.forEach(q => { if (q.tema) allTopics.add(q.tema); });

                    const weakTopicsSet = new Set(weakTopics);
                    const strongTopics = [...allTopics].filter(topic => !weakTopicsSet.has(topic));

                    if (strongTopics.length > 0) {
                        const topicsHTML = strongTopics.map(topic => 
                            `<span class="topic-tag-green"><i class="fas fa-check-circle icon"></i> ${topic}</span>`
                        ).join('');
                        $('#strongTopicsList').html(topicsHTML);
                        strongTopicsSection.show();
                    } else {
                        strongTopicsSection.hide();
                    }
                })
                .catch(e => strongTopicsSection.hide());
        }

        function trackMaterialView(materialId) {
            console.log('Material viewed:', materialId);
        }

        // ============================================
        // === CÓDIGO D3 MEJORADO (ORDENAMIENTO + COMPRESIÓN INTELIGENTE) ===
        // ============================================

        let svg, g, treeLayout, rootNode;
        let i = 0;
        const transitionDuration = 400;
        
        // Configuración Base
        const nodeWidth = 200;  // Ancho fijo
        const nodeHorizontalSeparation = 220; // REDUCIDO: Espacio entre columnas más pegado
        const baseVerticalSeparation = 80;    // REDUCIDO: Espacio base compacto

        // Función para medir la altura REAL que ocupará el texto
        function calcularAlturasReales(nodos) {
            const dummy = document.createElement('div');
            dummy.style.position = 'absolute';
            dummy.style.visibility = 'hidden';
            dummy.style.width = (nodeWidth - 16) + 'px'; 
            dummy.style.height = 'auto'; 
            
            dummy.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
            dummy.style.fontSize = '13px';
            dummy.style.fontWeight = '500';
            dummy.style.lineHeight = '1.2';
            dummy.style.padding = '0 8px';
            dummy.style.boxSizing = 'border-box';
            dummy.style.whiteSpace = 'normal';
            dummy.style.wordWrap = 'break-word';

            document.body.appendChild(dummy);

            nodos.forEach(n => {
                dummy.innerHTML = n.texto || "Texto vacío";
                const alturaRenderizada = dummy.getBoundingClientRect().height;
                // Altura final = texto + padding (~24px). Mínimo 60px.
                n.alturaReal = Math.max(60, alturaRenderizada + 24);
            });

            document.body.removeChild(dummy);
        }

        function renderizarArbolDecision(datos) {
            const container = $('#materialContent');
            
            // 1. Calcular alturas reales
            if (datos.datos && datos.datos.nodos) {
               calcularAlturasReales(datos.datos.nodos);
            }

            // 2. Convertir a jerarquía
            try {
                rootNode = d3.stratify()
                    .id(d => d.id)
                    .parentId(d => d.padre)
                    (datos.datos.nodos);
            } catch (error) {
                container.html('<div class="alert alert-danger">Error en jerarquía de datos</div>').fadeIn();
                return;
            }

            // 3. Ordenar: Rojos (weak) siempre arriba
            rootNode.each(node => {
                if (node.children) {
                    node.children.sort((a, b) => {
                        const weakA = a.data.es_tema_debil ? 1 : 0;
                        const weakB = b.data.es_tema_debil ? 1 : 0;
                        return weakB - weakA; 
                    });
                }
            });
            
            // 4. Configurar layout COMPACTO INICIAL
            // Usamos un espacio pequeño por defecto (80px) para que todo empiece pegado
            treeLayout = d3.tree().nodeSize([baseVerticalSeparation, nodeHorizontalSeparation]);

            // 5. Preparar HTML
            const html = `
                <div id="arbol-container" style="width: 100%; height: 800px; position: relative; overflow: hidden; background: #ffffff; border-radius: 12px;">
                    <svg id="arbol-svg" width="100%" height="100%"></svg>
                    <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000;">
                        <button id="zoom-in" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 20px;">+</button>
                        <button id="zoom-out" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 20px;">−</button>
                        <button id="zoom-reset" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 16px;">⟲</button>
                    </div>
                </div>
            `;
            container.html(html).fadeIn();

            const margin = { top: 20, right: 120, bottom: 20, left: 160 };
            const height = 800;

            svg = d3.select("#arbol-svg");
            g = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            const zoom = d3.zoom().scaleExtent([0.1, 2]).on("zoom", (event) => g.attr("transform", event.transform));
            svg.call(zoom).on("dblclick.zoom", null).style("cursor", "grab");

            const initialTransform = d3.zoomIdentity.translate(margin.left, height / 2);
            d3.select("#zoom-in").on("click", () => svg.transition().duration(300).call(zoom.scaleBy, 1.2));
            d3.select("#zoom-out").on("click", () => svg.transition().duration(300).call(zoom.scaleBy, 0.8));
            d3.select("#zoom-reset").on("click", () => svg.transition().duration(300).call(zoom.transform, initialTransform));
            
            // Colapsar inicial
            rootNode.descendants().forEach(d => {
                d.data.id = d.id;
                if (d.depth > 0 && d.children) { 
                    d._children = d.children; 
                    d.children = null; 
                }
            });
            
            rootNode.x0 = height / 2;
            rootNode.y0 = 0;

            updateArbol(rootNode);
            svg.call(zoom.transform, initialTransform);
        }

        function updateArbol(source) {
            // A. Ejecutar Layout Base (Compacto)
            treeLayout(rootNode);

            // B. [NUEVO] Ajuste de Espaciado Dinámico (Post-Procesamiento)
            // Ordenamos todos los nodos por su posición vertical (x) calculada por D3
            let nodes = rootNode.descendants().sort((a, b) => a.x - b.x);
            
            // Recorremos de arriba a abajo ajustando posiciones para evitar solapamientos
            for (let i = 1; i < nodes.length; i++) {
                let prev = nodes[i-1];
                let curr = nodes[i];
                
                // Calculamos la distancia MÍNIMA necesaria entre el nodo anterior y este
                // (Mitad de altura de uno + Mitad de altura del otro + 15px de margen)
                let minGap = (prev.data.alturaReal / 2) + (curr.data.alturaReal / 2) + 15;
                
                // Distancia actual que les dio el layout compacto
                let currentGap = curr.x - prev.x;
                
                // Si la distancia actual es menor a la necesaria (se solapan), empujamos
                if (currentGap < minGap) {
                    let pushAmount = minGap - currentGap;
                    curr.x += pushAmount;
                    // IMPORTANTE: Esto solo empuja al nodo actual respecto al anterior
                    // En la siguiente iteración (i+1), el siguiente nodo se comparará
                    // con la NUEVA posición de 'curr', propagando el empuje hacia abajo.
                }
            }

            // C. Renderizar normalmente con las nuevas coordenadas X ajustadas
            const links = rootNode.links();
            const node = g.selectAll("g.arbol-nodo")
                .data(nodes, d => d.id || (d.id = ++i));

            // Enter
            const nodeEnter = node.enter().append("g")
                .attr("class", "arbol-nodo")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .style("opacity", 0)
                .on("click", toggleNodo);

            // Rect con altura dinámica
            nodeEnter.append("rect")
                .attr("width", nodeWidth)
                .attr("height", 0) 
                .attr("x", -nodeWidth / 2)
                .attr("rx", d => obtenerEstiloNodo(d.data.nivel, d.data.es_tema_debil).borderRadius)
                .style("stroke-width", "2px");

            // ForeignObject con altura dinámica
            nodeEnter.append("foreignObject")
                .attr("width", nodeWidth - 16)
                .attr("height", 0) 
                .attr("x", -(nodeWidth / 2) + 8)
                .style("pointer-events", "none")
                .append("xhtml:div")
                .attr("class", "arbol-texto-contenedor");

            const botonToggle = nodeEnter.append("g").attr("class", "arbol-boton-toggle");
            botonToggle.append("circle").attr("r", 12).style("stroke-width", "2px");
            botonToggle.append("text").attr("text-anchor", "middle").attr("dy", "0.35em").attr("font-size", "14px").attr("font-weight", "bold");

            // Update
            const nodeUpdate = nodeEnter.merge(node);
            
            nodeUpdate.transition()
                .duration(transitionDuration)
                .attr("transform", d => `translate(${d.y},${d.x})`) // Usa la d.x AJUSTADA
                .style("opacity", 1);
            
            nodeUpdate.each(function(d) {
                const estilo = obtenerEstiloNodo(d.data.nivel, d.data.es_tema_debil);
                const h = d.data.alturaReal; 

                // Actualizar Rect
                d3.select(this).select("rect")
                    .transition().duration(transitionDuration)
                    .attr("height", h)
                    .attr("y", -h / 2) 
                    .attr("fill", estilo.background)
                    .attr("stroke", estilo.border);

                // Actualizar Texto
                let claseTexto = "arbol-texto-contenedor";
                if (d.data.es_tema_debil) claseTexto += " tema-debil";
                if (d.depth === 0) claseTexto += " raiz";

                // Actualizar ForeignObject
                d3.select(this).select("foreignObject")
                    .attr("height", h - 10) 
                    .attr("y", -(h / 2) + 5) 
                    .select("div")
                    .html(d.data.texto)
                    .attr("class", claseTexto);

                // Botón
                const boton = d3.select(this).select(".arbol-boton-toggle");
                if (d.children || d._children) {
                    boton.style("display", null)
                         .attr("transform", `translate(${nodeWidth / 2 + 15}, 0)`); 
                    
                    boton.select("circle")
                        .transition().duration(transitionDuration)
                        .attr("fill", estilo.buttonBackground)
                        .attr("stroke", estilo.border);
                    
                    boton.select("text")
                        .attr("fill", estilo.buttonColor)
                        .text(d.children ? "−" : "+");
                } else {
                    boton.style("display", "none");
                }
            });

            // Exit
            node.exit().transition()
                .duration(transitionDuration)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .style("opacity", 0)
                .remove();

            // Links
            const link = g.selectAll("path.arbol-link")
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "arbol-link")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 };
                    return diagonal({ source: o, target: o });
                })
                .style("stroke-opacity", 0);

            linkEnter.merge(link).transition()
                .duration(transitionDuration)
                .attr("d", diagonal)
                .style("stroke-opacity", 1);

            link.exit().transition()
                .duration(transitionDuration)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y };
                    return diagonal({ source: o, target: o });
                })
                .style("stroke-opacity", 0)
                .remove();
            
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
        
        function toggleNodo(event, d) {
            if (event.defaultPrevented) return; 
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else if (d._children) {
                d.children = d._children;
                d._children = null;
            }
            updateArbol(d);
        }

        function diagonal(d) {
            return d3.linkHorizontal()
                     .x(d => d.y)
                     .y(d => d.x)
                     (d);
        }

        function obtenerEstiloNodo(nivel, esTemaDebil) {
            const paleta = {
                raiz:   { border: '#8E44AD', button: '#7D3C98' },
                debil:  { border: '#E74C3C', button: '#C0392B' },
                fuerte: { border: '#2ECC71', button: '#28B463' }
            };
            
            let estiloBase;
            if (nivel === 0) estiloBase = paleta.raiz;
            else if (esTemaDebil) estiloBase = paleta.debil;
            else estiloBase = paleta.fuerte;
            
            return {
                background: '#FFFFFF',
                border: estiloBase.border,
                borderRadius: '16px',
                buttonBackground: estiloBase.button,
                buttonColor: 'white'
            };
        }
    </script>
</body>
</html>