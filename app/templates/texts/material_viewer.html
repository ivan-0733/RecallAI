{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Material... - RecallAI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
        :root {
            /* Se definen los colores base para cada tipo */
            --color-flashcard-bg: #e3f2fd;
            --color-flashcard-fg: #1976d2;
            --color-decision_tree-bg: #f3e5f5;
            --color-decision_tree-fg: #7b1fa2;
            --color-mind_map-bg: #e8f5e9;
            --color-mind_map-fg: #388e3c;
            --color-summary-bg: #fff3e0;
            --color-summary-fg: #f57c00;
            --color-default-bg: #f0f0f0;
            --color-default-fg: #555;
        }

        body { 
            background: #f4f6f9; 
            min-height: 100vh; 
            padding: 20px 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .material-container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        .material-header { 
            background: white; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden; 
        }
        
        .header-title-area {
            padding: 25px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            background: var(--color-default-bg); 
            color: var(--color-default-fg); 
            transition: all 0.5s ease;
            position: relative;
        }
        
        /* Se aplican los fondos de color din√°micamente */
        .header-title-area.type-flashcard {
            background: linear-gradient(135deg, var(--color-flashcard-bg) 0%, #ffffff 100%);
            color: var(--color-flashcard-fg);
            border-bottom: 3px solid var(--color-flashcard-fg);
        }
        .header-title-area.type-decision_tree {
            background: linear-gradient(135deg, var(--color-decision_tree-bg) 0%, #ffffff 100%);
            color: var(--color-decision_tree-fg);
            border-bottom: 3px solid var(--color-decision_tree-fg);
        }
        .header-title-area.type-mind_map {
            background: linear-gradient(135deg, var(--color-mind_map-bg) 0%, #ffffff 100%);
            color: var(--color-mind_map-fg);
            border-bottom: 3px solid var(--color-mind_map-fg);
        }
        .header-title-area.type-summary {
            background: linear-gradient(135deg, var(--color-summary-bg) 0%, #ffffff 100%);
            color: var(--color-summary-fg);
            border-bottom: 3px solid var(--color-summary-fg);
        }

        .header-title { 
            flex: 1; 
            min-width: 0; 
            text-align: center;
        }
        .header-title h1 {
            margin: 0;
            font-size: 1.7rem; 
            font-weight: 700;
            line-height: 1.3;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .header-title p {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        .header-title-area > div:last-child {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn-custom { 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.3s;
            flex-shrink: 0;
            background: #fff;
            color: #007bff;
            border: 1px solid #007bff;
        }
        .btn-custom:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
            background: #007bff;
            color: #fff;
        }

        /* --- INICIO DE ESTILOS PARA T√ìPICOS --- */
        .topics-section {
            padding: 20px 30px;
            background: #fff;
        }
        .topics-section.weak {
            border-bottom: 1px solid #eee; /* L√≠nea divisoria */
        }
        
        .topics-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .topics-title.weak { color: #721c24; }
        .topics-title.strong { color: #155724; } /* T√≠tulo verde oscuro */

        .topics-list { 
            display: flex; 
            flex-wrap: wrap;
            gap: 10px; 
        }
        
        /* Tags de Temas D√©biles (ROJOS) */
        .topic-tag-red { 
            background: #fff5f5; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .topic-tag-red .icon {
            margin-right: 8px;
            color: #c53030;
            font-size: 12px;
        }
        
        /* Tags de Temas Dominados (VERDES) */
        .topic-tag-green { 
            background: #f0fff4; /* Fondo verde muy claro */
            border: 1px solid #c3e6cb; /* Borde verde claro */
            color: #155724; /* Texto verde oscuro */
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .topic-tag-green .icon {
            margin-right: 8px;
            color: #28a745; /* Icono verde */
            font-size: 12px;
        }
        /* --- FIN DE ESTILOS PARA T√ìPICOS --- */

        .material-content { 
            background: white; 
            border-radius: 16px; 
            padding: 30px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
            min-height: 500px; 
        }
        
        #materialContent { animation: fadeIn 0.5s; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .loading-spinner { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 400px; 
            flex-direction: column; 
        }
        .spinner-border-custom { 
            width: 3rem; 
            height: 3rem; 
            border-width: 0.3em; 
        }

        /* --- (ACTUALIZADO) ESTILOS PARA EL √ÅRBOL D3 "HERMOSO" --- */
        #arbol-container {
            /* Fondo blanco para el lienzo */
            background-color: #ffffff !important; 
        }
        
        .arbol-link {
            /* Color de l√≠nea gris y s√≥lido */
            stroke: #ccc;
            stroke-width: 2px;
            fill: none;
        }
        
        g.arbol-nodo {
            cursor: pointer;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.08));
            /* (CORREGIDO) La transici√≥n de 'transform' la maneja D3 */
            transition: filter 0.3s ease;
        }
        g.arbol-nodo:hover {
            filter: drop-shadow(0 6px 16px rgba(0,0,0,0.12));
            /* (CORREGIDO) Eliminado el transform:scale() para evitar vibraciones */
        }
        
        g.arbol-nodo rect {
            /* Transici√≥n solo para el borde */
            transition: stroke 0.3s ease, fill 0.3s ease; 
        }
        
        /* (NUEVO) Estilo para el div dentro del foreignObject */
        .arbol-texto-contenedor {
            /* Este div maneja el centrado y el ajuste de texto */
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 10px; /* Padding interno para que el texto no toque los bordes */
            box-sizing: border-box; /* Importante para el padding */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #333333;
            /* Ajuste de texto autom√°tico */
            word-wrap: break-word; 
            word-break: break-word; /* Opcional: para palabras muy largas */
            line-height: 1.2;
        }

        /* (NUEVO) Estilo especial para el texto de temas d√©biles */
        .arbol-texto-contenedor.tema-debil {
            color: #E74C3C;
            font-weight: bold;
        }
        
        /* (NUEVO) Estilo para el texto de la ra√≠z */
        .arbol-texto-contenedor.raiz {
            font-size: 15px;
            font-weight: bold;
        }


        /* Estilo para el bot√≥n de expandir */
        .arbol-boton-toggle circle {
            transition: all 0.3s ease;
        }
        .arbol-boton-toggle:hover circle {
            transform: scale(1.1);
        }
        .arbol-boton-toggle text {
            pointer-events: none;
        }

    </style>
    </head>
<body>
    <div class="material-container">
        
        <div class="material-header">
    
            <div class="header-title-area" id="headerTitleArea">
                <div class="header-title">
                    <p id="materialType">Cargando...</p>
                    <h1 id="materialTitle">Material de Estudio</h1>
                </div>
                <div>
                    <a href="/dashboard/" class="btn btn-custom">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </div>
            </div>
        
            <div class="topics-section strong" id="strongTopicsContainer" style="display: none;">
                <h3 class="topics-title strong">Temas dominados (Temas generales)</h3>
                <div class="topics-list" id="strongTopicsList">
                    </div>
            </div>
            
            <div class="topics-section weak" id="weakTopicsContainer" style="display: none;">
                <h3 class="topics-title weak">Temas d√©biles</h3>
                <div class="topics-list" id="weakTopicsList">
                    </div>
            </div>
            
        </div>
        <div class="material-content">
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary spinner-border-custom" role="status">
                    <span class="sr-only">Cargando...</span>
                </div>
                <p class="mt-3 text-muted" id="loadingText">Generando tu material personalizado, esto puede tardar unos minutos...</p>
            </div>
            <div id="materialContent" style="display: none;">
                </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
    let materialData = null;
        // Se obtiene el ID del material desde la URL
        const materialId = window.location.pathname.split('/')[2]; 

        $(document).ready(function() {
            // Se inicia la carga directa del material
            loadMaterial();
        });

        function loadMaterial() {
            const token = localStorage.getItem('access_token');

            if (!token) {
                window.location.href = '/login/';
                return;
            }

            // Se llama al endpoint de la API para obtener el material
            const apiUrl = `/api/materials/${materialId}/`;

            $.ajax({
                url: apiUrl,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(material) {
                    // Si la llamada es exitosa, se muestra el material
                    materialData = material;
                    displayMaterial(materialData);
                    loadAndDisplayStrongTopics(material.text, material.weak_topics);
                },
                error: function(xhr) {
                    // Se manejan errores
                    if (xhr.status === 401) {
                        localStorage.clear();
                        window.location.href = '/login/';
                    } else if (xhr.status === 404) {
                        toastr.error('Material no encontrado.');
                        $('#loadingSpinner').show(); 
                        $('#loadingText').text('Este material no existe o no te pertenece.');
                        $('#materialType').text('Error');
                        $('#materialTitle').text('Material no encontrado');
                    } else {
                        toastr.error('Error al cargar el material.');
                        $('#loadingSpinner').show();
                        $('#loadingText').text('Ocurri√≥ un error inesperado al cargar el material.');
                        $('#materialType').text('Error');
                        $('#materialTitle').text('Error de carga');
                    }
                }
            });
        }
        
        function displayMaterial(material) {
            materialData = material;

            // Se a√±ade la clase de tipo al contenedor de la cabecera para cambiar el color
            $('#headerTitleArea').addClass('type-' + material.material_type);

            // Se actualiza el tipo de material (ej: FLASHCARDS)
            $('#materialType').text(material.material_type_display);
            
            // Se establece el t√≠tulo del texto en el H1 (ej: Procesamiento de Im√°genes)
            $('#materialTitle').text(material.text_title);

            // Se actualiza el t√≠tulo de la pesta√±a del navegador
            document.title = `${material.material_type_display}: ${material.text_title} - RecallAI`;
            
            // Se muestran los temas d√©biles (Rojos)
            if (material.weak_topics && material.weak_topics.length > 0) {
                const topicsHTML = material.weak_topics.map(topic => 
                    `<span class="topic-tag-red"><i class="fas fa-exclamation-triangle icon"></i> ${topic}</span>`
                ).join('');
                
                $('#weakTopicsList').html(topicsHTML);
                $('#weakTopicsContainer').show();
            }

            // ============================================
            // DETECCI√ìN MEJORADA DE √ÅRBOL DE DECISI√ìN
            // ============================================
            if (material.material_type === 'decision_tree') {
                console.log('üå≥ Tipo de material: decision_tree detectado');
                console.log('üìÑ Contenido recibido (primeros 200 chars):', material.html_content.substring(0, 200));
                
                let arbolData = null;
                
                try {
                    // INTENTO 1: Parsear directamente
                    arbolData = JSON.parse(material.html_content);
                    console.log('‚úÖ JSON parseado exitosamente (m√©todo directo)');
                } catch (e1) {
                    console.warn('‚ö†Ô∏è Fallo parseo directo:', e1.message);
                    
                    try {
                        // INTENTO 2: Limpiar markdown y extraer JSON
                        let cleanContent = material.html_content.trim();
                        
                        // Remover bloques de c√≥digo markdown
                        if (cleanContent.startsWith('```')) {
                            cleanContent = cleanContent.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                        }
                        
                        // Buscar el primer { y el √∫ltimo }
                        const jsonStart = cleanContent.indexOf('{');
                        const jsonEnd = cleanContent.lastIndexOf('}');
                        
                        if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                            cleanContent = cleanContent.substring(jsonStart, jsonEnd + 1);
                        }
                        
                        arbolData = JSON.parse(cleanContent);
                        console.log('‚úÖ JSON parseado exitosamente (m√©todo limpieza)');
                        
                    } catch (e2) {
                        console.error('‚ùå Error parseando √°rbol (ambos m√©todos):', e2);
                        console.error('Contenido completo:', material.html_content);
                        
                        $('#loadingSpinner').hide();
                        $('#materialContent').html(`
                            <div class="alert alert-danger">
                                <h4><i class="fas fa-exclamation-triangle"></i> Error al cargar el √°rbol de decisi√≥n</h4>
                                <p>El formato del √°rbol no es v√°lido. Por favor, intenta regenerar el material.</p>
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #0056b3; font-weight: 600;">Ver detalles t√©cnicos</summary>
                                    <pre style="max-height: 300px; overflow: auto; background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 11px; margin-top: 10px;">${material.html_content}</pre>
                                </details>
                            </div>
                        `).fadeIn();
                        
                        trackMaterialView(material.id);
                        return;
                    }
                }
                
                // Validar estructura del JSON
                if (!arbolData || !arbolData.datos || !arbolData.datos.nodos) {
                    console.error('‚ùå Estructura de √°rbol inv√°lida:', arbolData);
                    $('#loadingSpinner').hide();
                    $('#materialContent').html(`
                        <div class="alert alert-warning">
                            <h4><i class="fas fa-exclamation-circle"></i> Estructura de √°rbol incompleta</h4>
                            <p>El √°rbol no tiene la estructura esperada. Faltan campos obligatorios.</p>
                            <p><strong>Se esperaba:</strong> <code>{"datos": {"nodos": [...]}}</code></p>
                        </div>
                    `).fadeIn();
                    trackMaterialView(material.id);
                    return;
                }
                
                console.log('‚úÖ Estructura validada. Nodos encontrados:', arbolData.datos.nodos.length);
                
                // Renderizar el √°rbol
                $('#loadingSpinner').hide();
                renderizarArbolDecision(arbolData); // <--- ESTA ES LA NUEVA FUNCI√ìN D3 (v8 - Tree Corregida)
                trackMaterialView(material.id);
                return; // IMPORTANTE: Salir aqu√≠
            }
            // ============================================
            // FIN DETECCI√ìN √ÅRBOL
            // ============================================

            // FLUJO ORIGINAL (Flashcards y otros materiales HTML)
            let cleanHTML;
            if (material.material_type === 'flashcard') {
                cleanHTML = material.html_content;
                console.log('‚ö†Ô∏è Flashcard: HTML insertado directamente (scripts permitidos)');
            } else {
                cleanHTML = DOMPurify.sanitize(material.html_content, {
                    ADD_TAGS: ['style', 'script'],
                    ADD_ATTR: ['onclick', 'onmouseover', 'onmouseout', 'style', 'id', 'class']
                });
                console.log('‚úÖ Material sanitizado con DOMPurify');
            }

            $('#loadingSpinner').hide();
            
            const contentDiv = $('#materialContent');
            contentDiv.html(cleanHTML).fadeIn();
            
            if (material.material_type === 'flashcard') {
                const scripts = contentDiv.find('script');
                scripts.each(function() {
                    const scriptContent = $(this).html();
                    if (scriptContent) {
                        try {
                            window.eval(scriptContent);
                            console.log('‚úÖ Script ejecutado en window scope');
                        } catch (e) {
                            console.error('‚ùå Error ejecutando script:', e);
                        }
                    }
                });
            }
            
            trackMaterialView(material.id);
        }

        function loadAndDisplayStrongTopics(textId, weakTopics) {
            const strongTopicsSection = $('#strongTopicsContainer');
            
            fetch(`/api/texts/${textId}/quiz/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.quiz || !data.quiz.questions_json) {
                        console.warn('No quiz data found for this text, hiding strong topics section.');
                        strongTopicsSection.hide();
                        return; 
                    }
                    
                    const questions = data.quiz.questions_json;
                    const allTopics = new Set();
                    
                    questions.forEach(question => {
                        if (question.tema) {
                            allTopics.add(question.tema);
                        }
                    });

                    const weakTopicsSet = new Set(weakTopics);
                    const strongTopics = [...allTopics].filter(topic => !weakTopicsSet.has(topic));

                    if (strongTopics.length > 0) {
                        const topicsHTML = strongTopics.map(topic => 
                            `<span class="topic-tag-green"><i class="fas fa-check-circle icon"></i> ${topic}</span>`
                        ).join('');
                        
                        $('#strongTopicsList').html(topicsHTML);
                        strongTopicsSection.show();

                    } else {
                        strongTopicsSection.hide();
                    }
                })
                .catch(error => {
                    console.error('Error fetching strong topics:', error);
                    strongTopicsSection.hide();
                });
        }

        function trackMaterialView(materialId) {
            const token = localStorage.getItem('access_token');
            console.log('Material viewed:', materialId);
        }

        // ============================================
        // === INICIO C√ìDIGO D3 v8 (LAYOUT DE √ÅRBOL "HERMOSO" CORREGIDO) ===
        // ============================================

        // --- Variables globales para D3 Tree ---
        let svg, g, treeLayout, rootNode;
        let i = 0; // Contador para IDs √∫nicos si es necesario
        
        // --- (AJUSTABLE) Duraci√≥n de la animaci√≥n ---
        const transitionDuration = 400; // 400ms, m√°s r√°pido

        // --- (AJUSTABLE) Espaciado y tama√±o del √°rbol ---
        const nodeWidth = 200;                  // Ancho fijo del rect√°ngulo
        const nodeHeight = 60;                  // Alto fijo del rect√°ngulo
        const nodeHorizontalSeparation = 260;   // Espacio horizontal ENTRE nodos (columna a columna)
        
        // --- (CORREGIDO) Espaciado vertical m√°s junto ---
        const nodeVerticalSeparation = 80;      

        // 1. Funci√≥n principal que inicia el renderizado
        function renderizarArbolDecision(datos) {
            const container = $('#materialContent');
            
            if (!datos.datos || !datos.datos.nodos) {
                container.html('<div class="alert alert-danger">Error: Estructura de √°rbol inv√°lida</div>').fadeIn();
                return;
            }

            // 1. Convertir lista plana a jerarqu√≠a (¬°CR√çTICO!)
            try {
                rootNode = d3.stratify()
                    .id(d => d.id)
                    .parentId(d => d.padre)
                    (datos.datos.nodos);
            } catch (error) {
                console.error("Error al estratificar los datos:", error);
                console.error("Datos que fallaron:", datos.datos.nodos);
                container.html('<div class="alert alert-danger">Error: Los datos del √°rbol tienen una jerarqu√≠a rota (ej. un hijo sin padre).</div>').fadeIn();
                return;
            }
            
            // 2. Definir dimensiones y m√°rgenes
            const margin = { top: 20, right: 120, bottom: 20, left: 160 }; // M√°s margen izquierdo para el nodo ra√≠z
            const height = 800; // Alto fijo del viewport

            // 3. (CORREGIDO) Crear el layout de √°rbol de D3
            treeLayout = d3.tree().nodeSize([nodeVerticalSeparation, nodeHorizontalSeparation]);

            // 4. Limpiar contenedor y a√±adir HTML del SVG
            const html = `
                <div id="arbol-container" style="width: 100%; height: 800px; position: relative; overflow: hidden; background: #ffffff; border-radius: 12px;">
                    <svg id="arbol-svg" width="100%" height="100%"></svg>
                    
                    <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000;">
                        <button id="zoom-in" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 20px;">+</button>
                        <button id="zoom-out" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 20px;">‚àí</button>
                        <button id="zoom-reset" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 16px;">‚ü≤</button>
                    </div>
                </div>
            `;
            container.html(html).fadeIn();

            // 5. Seleccionar SVG y a√±adir grupo principal
            svg = d3.select("#arbol-svg");
            
            g = svg.append("g")
                   .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // 6. Definir el comportamiento de Zoom y Arrastre (Pan)
            const zoom = d3.zoom()
                .scaleExtent([0.1, 2])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom)
               .on("dblclick.zoom", null) // Deshabilitar zoom con doble click
               .style("cursor", "grab"); // Cursor para indicar que se puede arrastrar

            // 7. Conectar botones de zoom
            const initialTransform = d3.zoomIdentity.translate(margin.left, height / 2);
            d3.select("#zoom-in").on("click", () => svg.transition().duration(300).call(zoom.scaleBy, 1.2));
            d3.select("#zoom-out").on("click", () => svg.transition().duration(300).call(zoom.scaleBy, 0.8));
            d3.select("#zoom-reset").on("click", () => svg.transition().duration(300).call(zoom.transform, initialTransform));
            
            // 8. (CORREGIDO) Colapsar nodos iniciales
            rootNode.descendants().forEach(d => {
                d.data.id = d.id;
                // (NUEVA L√ìGICA) Colapsa todo lo que est√© en el nivel 1 o m√°s profundo (depth > 0)
                if (d.depth > 0) { 
                    if(d.children) { // Solo si tiene hijos
                        d._children = d.children; // Guarda los hijos
                        d.children = null; // Colapsa
                    }
                }
            });
            
            // 9. Guardar posici√≥n inicial (para animaci√≥n de entrada)
            rootNode.x0 = height / 2;
            rootNode.y0 = 0;

            // 10. Renderizar por primera vez
            updateArbol(rootNode);
            
            // 11. Centrar el nodo ra√≠z inicial
            svg.call(zoom.transform, initialTransform);
        }

        // 2. Funci√≥n de Actualizaci√≥n (El coraz√≥n del renderizado)
        function updateArbol(source) {
            
            // 1. Calcular el nuevo layout
            const treeData = treeLayout(rootNode);

            // 2. Obtener listas de nodos y enlaces
            const nodes = treeData.descendants();
            const links = treeData.links();

            // --- 4. ACTUALIZAR NODOS ---
            const node = g.selectAll("g.arbol-nodo")
                .data(nodes, d => d.id || (d.id = ++i));

            // --- Nodos que Entran (Nuevos) ---
            const nodeEnter = node.enter().append("g")
                .attr("class", "arbol-nodo")
                .attr("transform", d => `translate(${source.y0},${source.x0})`) // Inicia en la posici√≥n del padre
                .style("opacity", 0)
                .on("click", toggleNodo); // Asigna el click

            // (ACTUALIZADO) A√±adir Rect√°ngulo
            nodeEnter.append("rect")
                .attr("width", nodeWidth)
                .attr("height", nodeHeight)
                .attr("x", -nodeWidth / 2) // Centrar el rect√°ngulo
                .attr("y", -nodeHeight / 2) // Centrar el rect√°ngulo
                .attr("rx", d => obtenerEstiloNodo(d.data.nivel, d.data.es_tema_debil).borderRadius)
                .style("stroke-width", "2px");

            // (NUEVO) A√±adir foreignObject para el texto HTML
            nodeEnter.append("foreignObject")
                .attr("width", nodeWidth - 20) // Ancho - padding (10px a cada lado)
                .attr("height", nodeHeight - 10) // Alto - padding (5px arriba/abajo)
                .attr("x", - (nodeWidth / 2) + 10) // Posici√≥n x + padding
                .attr("y", - (nodeHeight / 2) + 5) // Posici√≥n y + padding
                .style("pointer-events", "none") // Evita que intercepte el click
                .append("xhtml:div")
                .attr("class", "arbol-texto-contenedor");


            // A√±adir Bot√≥n de Expandir
            const botonToggle = nodeEnter.append("g")
                .attr("class", "arbol-boton-toggle");

            botonToggle.append("circle").attr("r", 12).style("stroke-width", "2px");

            botonToggle.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .attr("font-size", "14px")
                .attr("font-weight", "bold");

            // --- Nodos que se Actualizan (Transici√≥n) ---
            const nodeUpdate = nodeEnter.merge(node);
            
            // Transici√≥n a la nueva posici√≥n
            nodeUpdate.transition()
                .duration(transitionDuration)
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .style("opacity", 1);
            
            // Actualizar el contenido y estilo de los nodos
            nodeUpdate.each(function(d) {
                const estilo = obtenerEstiloNodo(d.data.nivel, d.data.es_tema_debil);

                // Actualizar Rect√°ngulo (Colores "hermosos")
                d3.select(this).select("rect")
                    .transition().duration(transitionDuration)
                    .attr("fill", estilo.background) // Fondo blanco
                    .attr("stroke", estilo.border);   // Borde de color

                // (NUEVO) Actualizar Texto en el foreignObject
                let claseTexto = "arbol-texto-contenedor";
                if (d.data.es_tema_debil) claseTexto += " tema-debil";
                if (d.depth === 0) claseTexto += " raiz"; // Clase especial para la ra√≠z

                d3.select(this).select(".arbol-texto-contenedor")
                    .html(d.data.texto) // Asigna el HTML (texto)
                    .attr("class", claseTexto); // A√±ade clases de estilo

                // Actualizar Bot√≥n
                const boton = d3.select(this).select(".arbol-boton-toggle");
                
                if (d.children || d._children) { // Solo mostrar si tiene hijos (abiertos o colapsados)
                    boton.style("display", null)
                         .attr("transform", `translate(${nodeWidth / 2 + 15}, 0)`);
                    
                    boton.select("circle")
                        .transition().duration(transitionDuration)
                        .attr("fill", estilo.buttonBackground)
                        .attr("stroke", estilo.border);
                    
                    boton.select("text")
                        .attr("fill", estilo.buttonColor)
                        .text(d.children ? "‚àí" : "+"); // Si d.children existe, est√° abierto (mostrar -)
                } else {
                    boton.style("display", "none"); // Ocultar si es un nodo hoja
                }
            });

            // --- Nodos que Salen (Eliminados) ---
            const nodeExit = node.exit().transition()
                .duration(transitionDuration)
                .attr("transform", d => `translate(${source.y},${source.x})`) // Vuelve a la posici√≥n del padre
                .style("opacity", 0)
                .remove();

            // --- 5. ACTUALIZAR ENLACES (Links) ---
            const link = g.selectAll("path.arbol-link")
                .data(links, d => d.target.id);

            // --- Enlaces que Entran (Nuevos) ---
            const linkEnter = link.enter().insert("path", "g") // Insertar detr√°s de los nodos
                .attr("class", "arbol-link")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 }; // Posici√≥n inicial del padre
                    return diagonal({ source: o, target: o }); // Dibuja el link desde el padre
                })
                .style("stroke-opacity", 0);

            // --- Enlaces que se Actualizan (Transici√≥n) ---
            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(transitionDuration)
                .attr("d", diagonal) // Anima a la nueva posici√≥n
                .style("stroke-opacity", 1); // Opacidad completa para el color gris

            // --- Enlaces que Salen (Eliminados) ---
            link.exit().transition()
                .duration(transitionDuration)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y }; // Posici√≥n final del padre
                    return diagonal({ source: o, target: o }); // Anima el link para que colapse en el padre
                })
                .style("stroke-opacity", 0)
                .remove();
            
            // 6. Guardar posiciones antiguas para la pr√≥xima transici√≥n
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
        
        // 3. Funci√≥n Click (Toggle)
        function toggleNodo(event, d) {
            // No hacer nada si el evento viene de un zoom/drag
            if (event.defaultPrevented) return; 

            if (d.children) { // Si est√° abierto, colapsar
                d._children = d.children;
                d.children = null;
            } else if (d._children) { // Si est√° colapsado, expandir
                d.children = d._children;
                d._children = null;
            }
            updateArbol(d); // 'd' es el nodo "fuente" de la animaci√≥n
        }

        // 4. Generador de Path (Curva de B√©zier Horizontal)
        function diagonal(d) {
            // Genera el path de la curva
            return d3.linkHorizontal()
                     .x(d => d.y) // La 'x' en pantalla es nuestra 'y' en los datos (depth)
                     .y(d => d.x) // La 'y' en pantalla es nuestra 'x' en los datos (posici√≥n vertical)
                     (d);
        }

        // 5. (NUEVA PALETA "HERMOSA") Funciones de Estilo 
        function obtenerEstiloNodo(nivel, esTemaDebil) {
            
            // Paleta "Hermosa": Nodos blancos, bordes de color P√∫rpura, Verde y Gris
            const paleta = {
                0: { border: '#8E44AD', button: '#7D3C98' }, // Ra√≠z (P√∫rpura)
                1: { border: '#2ECC71', button: '#28B463' }, // Nivel 1 (Verde)
                2: { border: '#2ECC71', button: '#28B463' }, // Nivel 2 (Verde)
                3: { border: '#BDBDBD', button: '#9E9E9E' }  // Nivel 3 (Gris)
            };
            
            const estiloBase = paleta[nivel] || paleta[3];
            
            const estilo = {
                background: '#FFFFFF',          // Fondo blanco para todos
                border: estiloBase.border,      // Borde de color seg√∫n nivel
                borderRadius: '16px',           // Esquinas redondeadas
                buttonBackground: estiloBase.button,
                buttonColor: 'white'
                // El color del texto se maneja en el CSS (.arbol-texto-contenedor)
            };

            // Override para temas d√©biles (rojo amigable)
            if (esTemaDebil) {
                estilo.border = '#E74C3C'; // Borde rojo suave
                estilo.buttonBackground = '#C0392B';
            }
            
            return estilo;
        }

        // ============================================
        // === FIN C√ìDIGO D3 v8 (LAYOUT DE √ÅRBOL) ===
        // ============================================
    </script>
</body>
</html>