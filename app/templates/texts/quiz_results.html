{% extends 'base.html' %}

{% block title %}Resultados del Cuestionario{% endblock %}

{% block body_class %}sidebar-mini layout-fixed{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
        <li class="nav-item d-none d-sm-inline-block">
            <a href="/dashboard/" class="nav-link">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </li>
    </ul>
</nav>

<!-- Content Wrapper -->
<div class="content-wrapper" style="margin-left: 0;">
    <section class="content mt-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <!-- Resultado general -->
                    <div class="card" id="resultCard">
                        <div class="card-body text-center p-5">
                            <div id="resultIcon" class="mb-3"></div>
                            <h1 id="resultTitle" class="display-4"></h1>
                            <h2 id="resultScore" class="display-1 font-weight-bold"></h2>
                            <p id="resultMessage" class="lead"></p>
                            
                            <div class="row mt-4">
                                <div class="col-md-4">
                                    <div class="info-box">
                                        <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Correctas</span>
                                            <span class="info-box-number" id="correctCount">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="info-box">
                                        <span class="info-box-icon bg-danger"><i class="fas fa-times"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Incorrectas</span>
                                            <span class="info-box-number" id="incorrectCount">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="info-box">
                                        <span class="info-box-icon bg-info"><i class="far fa-clock"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Tiempo</span>
                                            <span class="info-box-number" id="timeSpent">0 min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Temas d√©biles -->
                    <div id="weakTopicsCard" class="card" style="display: none;">
                        <div class="card-header bg-warning">
                            <h3 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Temas que necesitas reforzar
                            </h3>
                        </div>
                        <div class="card-body">
                            <p>Fallaste m√°s en estos temas:</p>
                            <div id="weakTopicsList"></div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Pr√≥ximo paso:</strong> Genera material did√°ctico personalizado para estudiar estos temas.
                            </div>
                        </div>
                    </div>

                    <!-- Respuestas detalladas -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-list"></i>
                                Revisi√≥n Detallada
                            </h3>
                        </div>
                        <div class="card-body" id="detailedAnswers"></div>
                    </div>

                    <!-- Acciones -->
                    <div class="card">
                        <div class="card-body text-center">
                            <a href="/dashboard/" class="btn btn-primary btn-lg">
                                <i class="fas fa-home"></i> Ir al Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.onbeforeunload = null;
    
    let textId;
    let attemptId;
    let currentScore;

    $(document).ready(function() {
        const pathParts = window.location.pathname.split('/');
        textId = pathParts[2];
        
        const resultStr = localStorage.getItem('quiz_result');
        
        if (resultStr) {
            const result = JSON.parse(resultStr);
            displayResults(result);
            localStorage.removeItem('quiz_result');
        } else {
            loadResultsFromAPI();
        }
    });

    function loadResultsFromAPI() {
        const token = localStorage.getItem('access_token');
        
        if (!token) {
            window.location.href = '/login/';
            return;
        }
        
        $('#resultCard').html(`
            <div class="card-body text-center p-5">
                <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                <p>Cargando resultados...</p>
            </div>
        `);
        
        $.ajax({
            url: `/api/texts/${textId}/last-attempt/`,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(result) {
                displayResults(result);
            },
            error: function(xhr) {
                if (xhr.status === 404) {
                    $('#resultCard').html(`
                        <div class="card-body text-center p-5">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <h4>No se encontraron resultados</h4>
                            <p>A√∫n no has tomado este cuestionario.</p>
                            <a href="/dashboard/" class="btn btn-primary mt-3">
                                <i class="fas fa-home"></i> Volver al Dashboard
                            </a>
                        </div>
                    `);
                } else if (xhr.status === 401) {
                    localStorage.clear();
                    window.location.href = '/login/';
                } else {
                    $('#resultCard').html(`
                        <div class="card-body text-center p-5">
                            <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                            <h4>Error al cargar resultados</h4>
                            <a href="/dashboard/" class="btn btn-primary mt-3">
                                <i class="fas fa-home"></i> Volver al Dashboard
                            </a>
                        </div>
                    `);
                }
            }
        });
    }

    function displayResults(result) {
        const passed = result.passed;
        const score = result.score;
        attemptId = result.attempt.id;
        currentScore = score;
        
        let resultHTML = `
            <div class="card-body text-center p-5">
                ${passed 
                    ? '<i class="fas fa-trophy fa-5x text-success mb-3"></i><h1 class="display-4 text-success">¬°Felicidades! Has aprobado</h1>'
                    : '<i class="fas fa-times-circle fa-5x text-danger mb-3"></i><h1 class="display-4 text-danger">Necesitas mejorar</h1>'
                }
                <h2 class="display-1 font-weight-bold">${score.toFixed(1)}%</h2>
                <p class="lead">${result.message}</p>
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="info-box">
                            <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Correctas</span>
                                <span class="info-box-number">${result.correct_count}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box">
                            <span class="info-box-icon bg-danger"><i class="fas fa-times"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Incorrectas</span>
                                <span class="info-box-number">${result.total_questions - result.correct_count}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-box">
                            <span class="info-box-icon bg-info"><i class="far fa-clock"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Tiempo</span>
                                <span class="info-box-number">${Math.floor(result.attempt.time_spent_seconds / 60)}:${String(result.attempt.time_spent_seconds % 60).padStart(2, '0')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#resultCard').html(resultHTML);
        
        // NUEVO: Si NO aprob√≥, mostrar modal de selecci√≥n de material
        if (!passed && score < 80) {
            showMaterialSelector(result);
        }
        
        // Temas d√©biles
        if (result.weak_topics && result.weak_topics.length > 0) {
            $('#weakTopicsCard').show();
            
            let topicsHtml = '<ul class="list-group">';
            result.weak_topics.forEach(function(topic) {
                const errorCount = result.topic_errors[topic] || 0;
                topicsHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${topic}
                        <span class="badge badge-danger badge-pill">${errorCount} error(es)</span>
                    </li>
                `;
            });
            topicsHtml += '</ul>';
            
            $('#weakTopicsList').html(topicsHtml);
        }
        
        // Respuestas detalladas
        let detailedHtml = '';
        result.detailed_answers.forEach(function(answer, index) {
            const cardClass = answer.is_correct ? 'border-success' : 'border-danger';
            const iconClass = answer.is_correct ? 'fa-check-circle text-success' : 'fa-times-circle text-danger';
            
            detailedHtml += `
                <div class="card mb-3 ${cardClass}">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas ${iconClass}"></i>
                                Pregunta ${index + 1}
                            </h5>
                            <span class="badge badge-info">${answer.topic}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <p><strong>${answer.question}</strong></p>
                        <p>
                            <strong>Tu respuesta:</strong> 
                            <span class="${answer.is_correct ? 'text-success' : 'text-danger'}">${answer.selected_answer}</span>
                        </p>
                        ${!answer.is_correct ? `
                            <p><strong>Respuesta correcta:</strong> <span class="text-success">${answer.correct_answer}</span></p>
                            <div class="alert alert-info">
                                <strong>Explicaci√≥n:</strong> ${answer.explanation}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        $('#detailedAnswers').html(detailedHtml);
    }

    // NUEVA FUNCI√ìN: Mostrar modal de selecci√≥n de material
    function showMaterialSelector(result) {
        const token = localStorage.getItem('access_token');
        
        // Primero, obtener recomendaci√≥n
        $.ajax({
            url: `/api/texts/${textId}/recommendation/?attempt_id=${attemptId}`,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(recommendation) {
                renderMaterialModal(recommendation);
            },
            error: function() {
                // Si falla, mostrar sin recomendaci√≥n
                renderMaterialModal({has_recommendation: false});
            }
        });
    }

    function renderMaterialModal(recommendation) {
        let modalHTML = `
        <div class="modal fade" id="materialSelectorModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">
                            <i class="fas fa-lightbulb"></i>
                            ¬øQu√© tipo de material quieres usar para estudiar?
                        </h5>
                    </div>
                    <div class="modal-body">
        `;
        
        // Si hay recomendaci√≥n, mostrar banner
        if (recommendation.has_recommendation) {
            const materialNames = {
                'flashcard': 'Flashcards',
                'decision_tree': '√Årbol de Decisi√≥n',
                'mind_map': 'Mapa Mental',
                'summary': 'Resumen Estructurado'
            };
            
            modalHTML += `
                <div class="alert alert-success" role="alert">
                    <h5 class="alert-heading">
                        <i class="fas fa-star"></i> Recomendado para ti: <strong>${materialNames[recommendation.recommended_type]}</strong>
                    </h5>
                    <p class="mb-0">${recommendation.message}</p>
                </div>
            `;
        }
        
        // Opciones de material
        const materials = [
            {
                type: 'flashcard',
                icon: 'üìá',
                title: 'Flashcards Interactivas',
                description: 'Tarjetas con preguntas/respuestas que puedes voltear'
            },
            {
                type: 'decision_tree',
                icon: 'üå≥',
                title: '√Årbol de Decisi√≥n',
                description: 'Flujo interactivo para elegir t√©cnicas seg√∫n el problema'
            },
            {
                type: 'mind_map',
                icon: 'üó∫Ô∏è',
                title: 'Mapa Mental',
                description: 'Diagrama jer√°rquico colapsable de conceptos'
            },
            {
                type: 'summary',
                icon: 'üìÑ',
                title: 'Resumen Estructurado',
                description: 'Documento condensado con √©nfasis en tus temas d√©biles'
            }
        ];
        
        modalHTML += '<div class="row">';
        
        materials.forEach(function(material) {
            const isRecommended = recommendation.has_recommendation && recommendation.recommended_type === material.type;
            const cardClass = isRecommended ? 'border-success shadow-lg' : 'border-secondary';
            const effectiveness = recommendation.all_effectiveness ? recommendation.all_effectiveness[material.type] : 0;
            
            modalHTML += `
                <div class="col-md-6 mb-3">
                    <div class="card ${cardClass} h-100 material-option-card" data-type="${material.type}" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="card-body text-center">
                            ${isRecommended ? '<span class="badge badge-success mb-2">‚≠ê Recomendado</span>' : ''}
                            <h3 style="font-size: 3rem; margin-bottom: 10px;">${material.icon}</h3>
                            <h5 class="card-title">${material.title}</h5>
                            <p class="card-text text-muted">${material.description}</p>
                            ${recommendation.has_recommendation ? `
                                <div class="mt-2">
                                    <small class="text-muted">Tu mejora promedio: 
                                        <strong class="${effectiveness > 0 ? 'text-success' : 'text-secondary'}">
                                            ${effectiveness > 0 ? '+' + effectiveness + '%' : 'Sin datos'}
                                        </strong>
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        modalHTML += `
                    </div>
                </div>
                <div class="modal-footer">
                    <p class="text-muted mr-auto"><i class="fas fa-info-circle"></i> Selecciona el tipo que prefieras</p>
                </div>
            </div>
        </div>
    </div>
        `;
        
        $('body').append(modalHTML);
        $('#materialSelectorModal').modal('show');
        
        // Event listener para seleccionar material
        $('.material-option-card').on('click', function() {
            const selectedType = $(this).data('type');
            const wasRecommended = recommendation.has_recommendation;
            const followedRecommendation = recommendation.has_recommendation && selectedType === recommendation.recommended_type;
            
            generateMaterial(selectedType, wasRecommended, followedRecommendation);
        });
    }

    function generateMaterial(materialType, wasRecommended, followedRecommendation) {
        const token = localStorage.getItem('access_token');
        
        // Cerrar modal
        $('#materialSelectorModal').modal('hide');
        
        // Mostrar loading
        toastr.info('Generando material... Esto puede tomar 1-2 minutos', '', {
            timeOut: 5000
        });
        
        // Llamar a API
        $.ajax({
            url: '/api/texts/generate-material/',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                material_type: materialType,
                attempt_id: attemptId,
                was_recommended: wasRecommended,
                followed_recommendation: followedRecommendation
            }),
            success: function(response) {
                toastr.success('¬°Material encolado! Te redirigiremos cuando est√© listo...', '', {
                    timeOut: 3000
                });
                
                // Polling para verificar si ya est√° generado (cada 5 segundos)
                const pollInterval = setInterval(function() {
                    checkMaterialStatus(materialType, pollInterval);
                }, 5000);
            },
            error: function(xhr) {
                toastr.error('Error al generar material: ' + (xhr.responseJSON?.error || 'Error desconocido'));
            }
        });
    }

    function checkMaterialStatus(materialType, pollInterval) {
        const token = localStorage.getItem('access_token');
        
        $.ajax({
            url: '/api/texts/my-materials/',
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(materials) {
                // Buscar el material m√°s reciente del tipo solicitado
                const latestMaterial = materials.find(m => 
                    m.material_type === materialType && 
                    m.generated_at !== null
                );
                
                if (latestMaterial) {
                    clearInterval(pollInterval);
                    toastr.success('¬°Material listo! Redirigiendo...', '', {timeOut: 2000});
                    
                    // Redirigir al visor de material
                    setTimeout(function() {
                        window.location.href = `/material/${latestMaterial.id}/`;
                    }, 2000);
                }
            },
            error: function(xhr) {
                console.error('Error checking material status:', xhr);
                clearInterval(pollInterval);
                toastr.error('Error al verificar el estado del material');
            }
        });
    }
</script>
{% endblock %}